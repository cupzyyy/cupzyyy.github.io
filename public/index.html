<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deposit QRIS</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
    --bg:#0a0a0f;
    --card:rgba(255,255,255,.04);
    --border:rgba(255,255,255,.08);
    --sub:rgba(255,255,255,.45);
    --accent:#7c3aed;
    --accent2:#a855f7;
    --green:#22c55e;
    --red:#ef4444;
    --yellow:#eab308;
}
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:-apple-system,'Segoe UI',sans-serif;
    background:var(--bg);
    background-image:
        radial-gradient(ellipse at 20% 50%,rgba(124,58,237,.08) 0%,transparent 50%),
        radial-gradient(ellipse at 80% 20%,rgba(168,85,247,.06) 0%,transparent 50%);
    min-height:100vh;color:#fff;
    display:flex;justify-content:center;align-items:flex-start;
    padding:20px;padding-top:40px;
}
.card{
    background:var(--card);
    backdrop-filter:blur(20px);
    -webkit-backdrop-filter:blur(20px);
    border:1px solid var(--border);
    border-radius:20px;
    width:100%;max-width:400px;
    overflow:hidden;
}
.card-body{padding:28px}
.hdr{text-align:center;padding-bottom:20px;border-bottom:1px solid var(--border);margin-bottom:24px}
.hdr h1{
    font-size:22px;font-weight:700;margin-bottom:4px;
    background:linear-gradient(135deg,#fff,var(--accent2));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.hdr p{color:var(--sub);font-size:13px}
.field{margin-bottom:16px}
.field label{display:block;color:var(--sub);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px}
.inp-box{position:relative}
.inp-box .pre{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.3);font-weight:700;font-size:15px}
.inp-box input{
    width:100%;padding:14px 16px 14px 40px;
    background:rgba(255,255,255,.06);border:2px solid var(--border);
    border-radius:12px;color:#fff;font-size:22px;font-weight:700;outline:none;transition:.25s;
}
.inp-box input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,58,237,.12)}
.inp-box input::placeholder{color:rgba(255,255,255,.15);font-weight:400;font-size:16px}
.chips{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:20px}
.chip{
    padding:10px 4px;background:rgba(255,255,255,.04);
    border:1px solid var(--border);border-radius:10px;
    color:rgba(255,255,255,.6);font-size:13px;font-weight:600;
    cursor:pointer;transition:.2s;text-align:center;
}
.chip:hover,.chip.on{background:rgba(124,58,237,.15);border-color:var(--accent);color:#fff;transform:translateY(-1px)}
.btn1{
    width:100%;padding:15px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:700;
    cursor:pointer;transition:.3s;
}
.btn1:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 25px rgba(124,58,237,.35)}
.btn1:disabled{opacity:.4;cursor:not-allowed}
.btn1 .sp{display:none;width:18px;height:18px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin-right:8px;vertical-align:middle}
.btn1.loading .sp{display:inline-block}
.btn2{
    width:100%;padding:13px;background:rgba(255,255,255,.06);
    border:1px solid var(--border);border-radius:12px;
    color:rgba(255,255,255,.6);font-size:14px;font-weight:600;
    cursor:pointer;transition:.2s;margin-top:10px;
}
.btn2:hover{background:rgba(255,255,255,.1);color:#fff}
.sbar{display:flex;align-items:center;justify-content:center;gap:8px;padding:11px 16px;border-radius:10px;font-weight:600;font-size:13px;margin-bottom:16px}
.s-pend{background:rgba(234,179,8,.1);color:var(--yellow);border:1px solid rgba(234,179,8,.2)}
.s-ok{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}
.s-fail{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
.dot{width:6px;height:6px;background:var(--yellow);border-radius:50%;animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}
@keyframes spin{to{transform:rotate(360deg)}}
.timer{text-align:center;color:var(--sub);font-size:12px;margin-bottom:14px}
.timer b{color:var(--yellow);font-size:16px}
.qr-sec{display:flex;flex-direction:column;align-items:center;margin:16px 0}
.qr-frame{background:#fff;padding:12px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.25);line-height:0}
.qr-hint{color:var(--sub);font-size:11px;margin-top:10px}
.amt{text-align:center;font-size:30px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:14px 0}
.fee-info{text-align:center;color:var(--sub);font-size:12px;margin-top:-8px;margin-bottom:12px}
.fee-info .fee-line{
    display:inline-block;
    background:rgba(255,255,255,.05);
    border:1px solid var(--border);
    border-radius:8px;
    padding:4px 12px;
    font-size:11px;
}
.det{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:16px}
.dr{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
.dr+.dr{border-top:1px solid rgba(255,255,255,.04)}
.dr .k{color:var(--sub);font-size:12px}
.dr .v{color:#fff;font-size:13px;font-weight:600}
.dr .v.mono{font-family:'Courier New',monospace;font-size:11px}
.dr .v.green{color:var(--green)}
.cpbtn{background:rgba(124,58,237,.15);border:1px solid rgba(124,58,237,.3);color:var(--accent2);padding:3px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;margin-left:6px}
.cpbtn:hover{background:rgba(124,58,237,.25)}
.res-icon{font-size:56px;text-align:center;animation:popIn .4s cubic-bezier(.68,-.55,.27,1.55)}
.res-text-ok{text-align:center;color:var(--green);font-weight:700;font-size:16px;margin-top:6px}
.res-text-fail{text-align:center;color:var(--red);font-weight:700;font-size:16px;margin-top:6px}
@keyframes popIn{0%{transform:scale(0) rotate(-15deg);opacity:0}100%{transform:scale(1) rotate(0);opacity:1}}
.toast{
    position:fixed;bottom:30px;left:50%;
    transform:translateX(-50%) translateY(100px);
    background:rgba(0,0,0,.85);backdrop-filter:blur(10px);
    color:#fff;padding:12px 24px;border-radius:10px;
    font-size:13px;font-weight:600;z-index:999;
    transition:transform .3s cubic-bezier(.68,-.55,.27,1.55);
    pointer-events:none;
}
.toast.show{transform:translateX(-50%) translateY(0)}
.pg{display:none}.pg.on{display:block}
@media(max-width:440px){
    body{padding:12px;padding-top:20px}
    .card-body{padding:20px}
    .hdr h1{font-size:20px}
    .amt{font-size:26px}
    .inp-box input{font-size:18px}
}
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<div class="card"><div class="card-body">

<!-- ========== PAGE: FORM ========== -->
<div class="pg on" id="pgForm">
    <div class="hdr">
        <h1>üí≥ Deposit QRIS</h1>
        <p>Top up saldo via QRIS ‚Äî semua e-wallet & bank</p>
    </div>
    <div class="field">
        <label>Jumlah Deposit</label>
        <div class="inp-box">
            <span class="pre">Rp</span>
            <input type="number" id="inpAmt" placeholder="Masukkan nominal" min="1000" inputmode="numeric">
        </div>
    </div>
    <div class="chips">
        <button class="chip" data-v="5000">5.000</button>
        <button class="chip" data-v="10000">10.000</button>
        <button class="chip" data-v="15000">15.000</button>
        <button class="chip" data-v="20000">20.000</button>
        <button class="chip" data-v="50000">50.000</button>
        <button class="chip" data-v="100000">100.000</button>
    </div>
    <button class="btn1" id="btnGo" onclick="doCreate()">
        <span class="sp"></span>
        <span class="bt">üîê Buat Deposit</span>
    </button>
</div>

<!-- ========== PAGE: INVOICE ========== -->
<div class="pg" id="pgInv">
    <div class="hdr">
        <h1>üìã Invoice Deposit</h1>
        <p>Scan QR untuk menyelesaikan pembayaran</p>
    </div>
    <div class="sbar s-pend" id="sbar">
        <div class="dot" id="sdot"></div>
        <span id="stxt">Menunggu Pembayaran</span>
    </div>
    <div class="timer" id="tmr">Berlaku <b id="cd">05:00</b></div>
    <div class="qr-sec" id="qrSec">
        <div class="qr-frame"><div id="qr"></div></div>
        <div class="qr-hint">Scan dengan GoPay, OVO, DANA, ShopeePay, atau M-Banking</div>
    </div>
    <div class="amt" id="dAmt">Rp 0</div>
    <div class="fee-info" id="dFee"></div>
    <div class="det">
        <div class="dr">
            <span class="k">Order ID</span>
            <span>
                <span class="v mono" id="dOid">-</span>
                <button class="cpbtn" onclick="cpId()">Copy</button>
            </span>
        </div>
        <div class="dr">
            <span class="k">Metode</span>
            <span class="v">QRIS</span>
        </div>
        <div class="dr">
            <span class="k">Deposit</span>
            <span class="v" id="dDeposit">-</span>
        </div>
        <div class="dr">
            <span class="k">Fee</span>
            <span class="v" id="dFeeRow">-</span>
        </div>
        <div class="dr">
            <span class="k">Total Bayar</span>
            <span class="v green" id="dTotal">-</span>
        </div>
        <div class="dr">
            <span class="k">Status</span>
            <span class="v" id="dSt">PENDING</span>
        </div>
    </div>
    <button class="btn2" onclick="goBack()">‚Üê Buat Deposit Baru</button>
</div>

<!-- ========== PAGE: SUCCESS ========== -->
<div class="pg" id="pgOk">
    <div class="hdr">
        <h1>üéâ Berhasil!</h1>
        <p>Deposit kamu sudah diterima</p>
    </div>
    <div style="padding:20px 0">
        <div class="res-icon">‚úÖ</div>
        <div class="res-text-ok">PEMBAYARAN BERHASIL</div>
    </div>
    <div class="amt" id="okAmt">Rp 0</div>
    <div class="det">
        <div class="dr"><span class="k">Order ID</span><span class="v mono" id="okOid">-</span></div>
        <div class="dr"><span class="k">Deposit</span><span class="v" id="okDeposit">-</span></div>
        <div class="dr"><span class="k">Fee</span><span class="v" id="okFee">-</span></div>
        <div class="dr"><span class="k">Total Dibayar</span><span class="v green" id="okTotal">-</span></div>
        <div class="dr"><span class="k">Status</span><span class="v" style="color:#22c55e">COMPLETED ‚úì</span></div>
        <div class="dr"><span class="k">Waktu</span><span class="v" id="okTime">-</span></div>
    </div>
    <button class="btn1" onclick="goBack()"><span class="bt">üí≥ Deposit Lagi</span></button>
</div>

<!-- ========== PAGE: FAILED ========== -->
<div class="pg" id="pgFail">
    <div class="hdr">
        <h1>üòî Gagal</h1>
        <p>Pembayaran tidak berhasil</p>
    </div>
    <div style="padding:20px 0">
        <div class="res-icon">‚ùå</div>
        <div class="res-text-fail" id="failWhy">EXPIRED</div>
    </div>
    <div class="det">
        <div class="dr"><span class="k">Order ID</span><span class="v mono" id="failOid">-</span></div>
        <div class="dr"><span class="k">Nominal</span><span class="v" id="failNom">-</span></div>
    </div>
    <button class="btn1" onclick="goBack()"><span class="bt">üîÑ Coba Lagi</span></button>
</div>

</div></div>

<script>
let S={oid:"",amt:0,total:0,fee:0,tl:300,si:null,ci:null};
const $=id=>document.getElementById(id);
const rp=n=>"Rp "+Number(n).toLocaleString("id-ID");
function pg(id){document.querySelectorAll(".pg").forEach(p=>p.classList.remove("on"));$(id).classList.add("on")}
function toast(m,ms=2500){const t=$("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),ms)}

document.querySelectorAll(".chip").forEach(b=>{
    b.onclick=()=>{
        $("inpAmt").value=b.dataset.v;
        document.querySelectorAll(".chip").forEach(c=>c.classList.remove("on"));
        b.classList.add("on");
    };
});
$("inpAmt").addEventListener("input",()=>{document.querySelectorAll(".chip").forEach(c=>c.classList.remove("on"))});
$("inpAmt").addEventListener("keydown",e=>{if(e.key==="Enter")doCreate()});

async function doCreate(){
    const amt=parseInt($("inpAmt").value);
    if(!amt||amt<1000){toast("‚ö†Ô∏è Minimal Rp 1.000");$("inpAmt").focus();return}
    if(amt>10000000){toast("‚ö†Ô∏è Maksimal Rp 10.000.000");return}
    const btn=$("btnGo");
    btn.disabled=true;btn.classList.add("loading");
    try{
        const r=await fetch("/api/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:amt})});
        const d=await r.json();
        if(!d.ok){toast("‚ùå "+(d.error||"Gagal"));return}

        S.oid=d.order_id;
        S.amt=d.amount;
        S.total=d.total_payment;
        S.fee=d.fee;
        S.tl=300;

        if(d.expired_at){
            const diff=Math.floor((new Date(d.expired_at).getTime()-Date.now())/1000);
            if(diff>0)S.tl=diff;
        }

        pg("pgInv");
        resetStatus();

        $("qr").innerHTML="";
        new QRCode($("qr"),{text:d.qris,width:220,height:220,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.M});

        $("dAmt").textContent=rp(d.total_payment);
        if(d.fee>0){
            $("dFee").innerHTML=`<span class="fee-line">üí∞ ${rp(d.amount)} + ‚ö° Fee ${rp(d.fee)}</span>`;
        }else{
            $("dFee").textContent="";
        }
        $("dOid").textContent=d.order_id;
        $("dDeposit").textContent=rp(d.amount);
        $("dFeeRow").textContent=d.fee>0?rp(d.fee):"Rp 0";
        $("dTotal").textContent=rp(d.total_payment);
        $("dSt").textContent="PENDING";

        startCountdown();
        startCheck();
    }catch(e){
        toast("‚ùå "+e.message);
    }finally{
        btn.disabled=false;btn.classList.remove("loading");
    }
}

function resetStatus(){
    $("sbar").className="sbar s-pend";
    $("sdot").style.display="block";
    $("stxt").textContent="Menunggu Pembayaran";
    $("tmr").style.display="block";
    $("qrSec").style.display="flex";
    $("cd").style.color="";
}

function startCountdown(){
    clearInterval(S.ci);
    S.ci=setInterval(()=>{
        S.tl--;
        const m=String(Math.floor(S.tl/60)).padStart(2,"0");
        const s=String(S.tl%60).padStart(2,"0");
        $("cd").textContent=m+":"+s;
        if(S.tl<=60)$("cd").style.color="#ef4444";
        if(S.tl<=0){clearInterval(S.ci);clearInterval(S.si);showFail("EXPIRED ‚Äî Waktu habis")}
    },1000);
}

function startCheck(){
    clearInterval(S.si);
    S.si=setInterval(async()=>{
        try{
            const r=await fetch("/api/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({order_id:S.oid,amount:S.amt})});
            const d=await r.json();
            if(d.status==="completed"){clearInterval(S.si);clearInterval(S.ci);showOk()}
            else if(d.status==="expired"){clearInterval(S.si);clearInterval(S.ci);showFail("EXPIRED ‚Äî Waktu habis")}
            else if(d.status==="failed"||d.status==="cancelled"){clearInterval(S.si);clearInterval(S.ci);showFail("GAGAL ‚Äî Pembayaran ditolak")}
        }catch(e){}
    },3000);
}

function showOk(){
    $("sbar").className="sbar s-ok";
    $("sdot").style.display="none";
    $("stxt").textContent="‚úÖ Pembayaran Berhasil!";
    $("okAmt").textContent=rp(S.total);
    $("okOid").textContent=S.oid;
    $("okDeposit").textContent=rp(S.amt);
    $("okFee").textContent=S.fee>0?rp(S.fee):"Rp 0";
    $("okTotal").textContent=rp(S.total);
    $("okTime").textContent=new Date().toLocaleString("id-ID");
    setTimeout(()=>pg("pgOk"),800);
}

function showFail(reason){
    $("sbar").className="sbar s-fail";
    $("sdot").style.display="none";
    $("stxt").textContent="‚ùå "+reason;
    $("tmr").style.display="none";
    $("failWhy").textContent=reason;
    $("failOid").textContent=S.oid;
    $("failNom").textContent=rp(S.total);
    setTimeout(()=>pg("pgFail"),1000);
}

function goBack(){
    clearInterval(S.si);clearInterval(S.ci);
    S.oid="";S.amt=0;S.total=0;S.fee=0;S.tl=300;
    $("inpAmt").value="";$("cd").style.color="";
    document.querySelectorAll(".chip").forEach(c=>c.classList.remove("on"));
    pg("pgForm");
}

function cpId(){
    if(!S.oid)return;
    navigator.clipboard.writeText(S.oid).then(()=>toast("üìã Order ID disalin!")).catch(()=>{
        const t=document.createElement("textarea");t.value=S.oid;
        document.body.appendChild(t);t.select();document.execCommand("copy");
        document.body.removeChild(t);toast("üìã Order ID disalin!");
    });
}
</script>
</body>
</html>
