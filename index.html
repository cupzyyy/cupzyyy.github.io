<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Referral Program</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
    }
    
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .admin-header {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .admin-header h1 {
      font-size: 28px;
    }
    
    .admin-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 30px;
      background: #f8f9fa;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #666;
      font-size: 14px;
    }
    
    .admin-content {
      padding: 30px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    
    .section {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
      font-size: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: #f8f9fa;
      padding: 12px;
      text-align: left;
      color: #555;
      font-weight: 600;
      border-bottom: 2px solid #dee2e6;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #dee2e6;
      color: #666;
    }
    
    tr:hover {
      background: #f8f9fa;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-approve {
      background: #10b981;
      color: white;
    }
    
    .btn-reject {
      background: #ef4444;
      color: white;
      margin-left: 5px;
    }
    
    .btn-logout {
      background: #ef4444;
      color: white;
      padding: 10px 20px;
    }
    
    .status-pending {
      color: #f59e0b;
      font-weight: 600;
    }
    
    .status-success {
      color: #10b981;
      font-weight: 600;
    }
    
    .status-rejected {
      color: #ef4444;
      font-weight: 600;
    }
    
    .search-box {
      padding: 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #dee2e6;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
      transition: border 0.3s;
    }
    
    .search-input:focus {
      border-color: #667eea;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-title {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .btn-cancel {
      background: #6c757d;
      color: white;
    }
    
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-top: 10px;
      resize: vertical;
      min-height: 100px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1>Admin Panel - Referral Program</h1>
        <p>Manage users, referrals, and withdrawals</p>
      </div>
      <button class="btn btn-logout" onclick="logout()">Logout</button>
    </div>
    
    <div class="search-box">
      <input type="text" class="search-input" placeholder="Search users by email or ID..." onkeyup="searchUsers(this.value)">
    </div>
    
    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-label">Total Users</div>
        <div class="stat-value" id="totalUsers">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Referrals</div>
        <div class="stat-value" id="totalReferrals">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Pending Withdrawals</div>
        <div class="stat-value" id="pendingWithdrawals">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Withdrawn</div>
        <div class="stat-value" id="totalWithdrawn">Rp0</div>
      </div>
    </div>
    
    <div class="admin-content">
      <div class="section">
        <h2 class="section-title">Pending Withdrawals</h2>
        <div id="withdrawalList">
          <p>Loading withdrawals...</p>
        </div>
      </div>
      
      <div class="section">
        <h2 class="section-title">Recent Users</h2>
        <div id="userList">
          <p>Loading users...</p>
        </div>
      </div>
      
      <div class="section" style="grid-column: span 2;">
        <h2 class="section-title">Recent Referrals</h2>
        <div id="referralList">
          <p>Loading referrals...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal for rejection reason -->
  <div class="modal" id="rejectModal">
    <div class="modal-content">
      <h2 class="modal-title">Reject Withdrawal</h2>
      <p>Enter rejection reason:</p>
      <textarea id="rejectionReason" placeholder="Example: Invalid account number, minimum withdrawal not met, etc."></textarea>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeRejectModal()">Cancel</button>
        <button class="btn btn-reject" onclick="confirmReject()">Confirm Reject</button>
      </div>
    </div>
  </div>
  
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCf230zCliSZ9EYLByMnmflqw8sOz328Uc",
      authDomain: "database-cupz.firebaseapp.com",
      projectId: "database-cupz",
      storageBucket: "database-cupz.firebasestorage.app",
      messagingSenderId: "343357519412",
      appId: "1:343357519412:web:dce862636c7c459e6a3c61"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let currentWithdrawalId = null;
    
    // Check admin status
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (userDoc.exists && userDoc.data().role === 'admin') {
          loadDashboardData();
          setupRealTimeListeners();
        } else {
          alert('Access denied. Admin only.');
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });
    
    async function loadDashboardData() {
      // Load total users
      const usersSnapshot = await db.collection('users').get();
      document.getElementById('totalUsers').textContent = usersSnapshot.size;
      
      // Load total referrals
      const referralsSnapshot = await db.collection('referrals').get();
      document.getElementById('totalReferrals').textContent = referralsSnapshot.size;
      
      // Load pending withdrawals
      const pendingWithdrawals = await db.collection('withdrawals')
        .where('status', '==', 'pending')
        .get();
      document.getElementById('pendingWithdrawals').textContent = pendingWithdrawals.size;
      
      // Load total withdrawn
      const successWithdrawals = await db.collection('withdrawals')
        .where('status', '==', 'success')
        .get();
      
      let totalWithdrawn = 0;
      successWithdrawals.forEach(doc => {
        totalWithdrawn += doc.data().amount || 0;
      });
      document.getElementById('totalWithdrawn').textContent = 'Rp' + totalWithdrawn.toLocaleString('id-ID');
      
      // Load recent users
      loadRecentUsers();
      
      // Load pending withdrawals list
      loadWithdrawalList();
      
      // Load recent referrals
      loadRecentReferrals();
    }
    
    async function loadRecentUsers() {
      const usersSnapshot = await db.collection('users')
        .orderBy('createdAt', 'desc')
        .limit(10)
        .get();
      
      let html = '<table>';
      html += '<tr><th>Email</th><th>Balance</th><th>Referrals</th><th>Joined</th></tr>';
      
      usersSnapshot.forEach(doc => {
        const user = doc.data();
        const date = user.createdAt?.toDate() || new Date();
        
        html += `
          <tr>
            <td>${user.email}</td>
            <td>Rp${(user.balance || 0).toLocaleString('id-ID')}</td>
            <td>${user.referralCount || 0}</td>
            <td>${date.toLocaleDateString('id-ID')}</td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('userList').innerHTML = html;
    }
    
    async function loadWithdrawalList() {
      const withdrawalsSnapshot = await db.collection('withdrawals')
        .where('status', '==', 'pending')
        .orderBy('timestamp', 'desc')
        .get();
      
      if (withdrawalsSnapshot.empty) {
        document.getElementById('withdrawalList').innerHTML = '<p>No pending withdrawals</p>';
        return;
      }
      
      let html = '<table>';
      html += '<tr><th>User</th><th>Amount</th><th>Method</th><th>Account</th><th>Date</th><th>Actions</th></tr>';
      
      withdrawalsSnapshot.forEach(doc => {
        const wd = doc.data();
        const date = wd.timestamp?.toDate() || new Date();
        
        html += `
          <tr>
            <td>${wd.userEmail}</td>
            <td>Rp${wd.amount?.toLocaleString('id-ID') || '0'}</td>
            <td>${wd.method || 'Unknown'}</td>
            <td>${wd.accountInfo || ''}</td>
            <td>${date.toLocaleDateString('id-ID')}</td>
            <td>
              <button class="btn btn-approve" onclick="approveWithdrawal('${doc.id}')">Approve</button>
              <button class="btn btn-reject" onclick="showRejectModal('${doc.id}')">Reject</button>
            </td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('withdrawalList').innerHTML = html;
    }
    
    async function loadRecentReferrals() {
      const referralsSnapshot = await db.collection('referrals')
        .orderBy('timestamp', 'desc')
        .limit(15)
        .get();
      
      let html = '<table>';
      html += '<tr><th>Referrer</th><th>Referred</th><th>Referrer Bonus</th><th>Referred Bonus</th><th>Date</th></tr>';
      
      referralsSnapshot.forEach(doc => {
        const ref = doc.data();
        const date = ref.timestamp?.toDate() || new Date();
        
        html += `
          <tr>
            <td>${ref.referrerEmail}</td>
            <td>${ref.referredEmail}</td>
            <td>Rp${ref.referrerBonus || 250}</td>
            <td>Rp${ref.referredBonus || 100}</td>
            <td>${date.toLocaleDateString('id-ID')}</td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('referralList').innerHTML = html;
    }
    
    async function approveWithdrawal(withdrawalId) {
      if (!confirm('Approve this withdrawal?')) return;
      
      try {
        const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
        const withdrawalData = withdrawalDoc.data();
        
        await db.collection('withdrawals').doc(withdrawalId).update({
          status: 'success',
          approvedBy: currentUser.email,
          approvedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Send notification to user
        await db.collection('notifications').add({
          userId: withdrawalData.userId,
          userEmail: withdrawalData.userEmail,
          type: 'withdrawal_approved',
          message: `ðŸŽ‰ PENARIKAN DITERIMA!\n\nðŸ’° Jumlah: Rp${withdrawalData.amount.toLocaleString('id-ID')}\nðŸ“± Metode: ${withdrawalData.method}\nðŸ¦ Tujuan: ${withdrawalData.accountInfo}\nâœ… Status: SUCCESS\n\nDana akan masuk dalam 1-5 menit.`,
          read: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Withdrawal approved successfully!');
        loadDashboardData();
        
      } catch (error) {
        console.error('Error approving withdrawal:', error);
        alert('Error: ' + error.message);
      }
    }
    
    function showRejectModal(withdrawalId) {
      currentWithdrawalId = withdrawalId;
      document.getElementById('rejectModal').style.display = 'flex';
    }
    
    function closeRejectModal() {
      document.getElementById('rejectModal').style.display = 'none';
      document.getElementById('rejectionReason').value = '';
      currentWithdrawalId = null;
    }
    
    async function confirmReject() {
      const reason = document.getElementById('rejectionReason').value.trim();
      
      if (!reason) {
        alert('Please enter rejection reason');
        return;
      }
      
      try {
        const withdrawalDoc = await db.collection('withdrawals').doc(currentWithdrawalId).get();
        const withdrawalData = withdrawalDoc.data();
        
        // Return balance to user
        await db.collection('users').doc(withdrawalData.userId).update({
          balance: firebase.firestore.FieldValue.increment(withdrawalData.amount)
        });
        
        await db.collection('withdrawals').doc(currentWithdrawalId).update({
          status: 'rejected',
          rejectedBy: currentUser.email,
          rejectionReason: reason,
          rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Send notification to user
        await db.collection('notifications').add({
          userId: withdrawalData.userId,
          userEmail: withdrawalData.userEmail,
          type: 'withdrawal_rejected',
          message: `âŒ PENARIKAN DITOLAK!\n\nðŸ’° Jumlah: Rp${withdrawalData.amount.toLocaleString('id-ID')}\nðŸ“± Metode: ${withdrawalData.method}\nðŸ¦ Tujuan: ${withdrawalData.accountInfo}\nðŸ“ Alasan: ${reason}\n\nSaldo telah dikembalikan ke akun Anda.`,
          read: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('Withdrawal rejected successfully!');
        closeRejectModal();
        loadDashboardData();
        
      } catch (error) {
        console.error('Error rejecting withdrawal:', error);
        alert('Error: ' + error.message);
      }
    }
    
    async function searchUsers(searchTerm) {
      if (!searchTerm) {
        loadRecentUsers();
        return;
      }
      
      const usersSnapshot = await db.collection('users')
        .where('email', '>=', searchTerm)
        .where('email', '<=', searchTerm + '\uf8ff')
        .limit(20)
        .get();
      
      let html = '<table>';
      html += '<tr><th>Email</th><th>Balance</th><th>Referrals</th><th>Joined</th><th>User ID</th></tr>';
      
      usersSnapshot.forEach(doc => {
        const user = doc.data();
        const date = user.createdAt?.toDate() || new Date();
        
        html += `
          <tr>
            <td>${user.email}</td>
            <td>Rp${(user.balance || 0).toLocaleString('id-ID')}</td>
            <td>${user.referralCount || 0}</td>
            <td>${date.toLocaleDateString('id-ID')}</td>
            <td style="font-size: 10px;">${doc.id.substring(0, 8)}...</td>
          </tr>
        `;
      });
      
      html += '</table>';
      document.getElementById('userList').innerHTML = html;
    }
    
    function setupRealTimeListeners() {
      // Real-time updates for withdrawals
      db.collection('withdrawals')
        .where('status', '==', 'pending')
        .onSnapshot((snapshot) => {
          loadDashboardData();
        });
    }
    
    function logout() {
      auth.signOut();
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
